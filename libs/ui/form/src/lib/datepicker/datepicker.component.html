<div [class]="containerClassFinal()">
  <!-- =====================
       Input + calendar icon
       ===================== -->
  <div [class]="disabledClassFinal()" [class.opacity-60]="isDisabled()" [class.pointer-events-none]="isDisabled()">
    <div [class]="fieldClassFinal()">
      <input
        #inputEl
        type="text"
        [class]="inputClassFinal()"
        [value]="inputValue()"
        [placeholder]="displayFormat()"
        [disabled]="disabledFinal()"
        (input)="onInput($event)"
        (focus)="open('programmatic')"
        (blur)="onBlur()"
        (keydown)="onKeydown($event)"
        autocomplete="off"
      />

      <!-- Calendar icon -->
      <button
        type="button"
        [class]="toggleClassFinal()"
        (click)="toggleOverlay()"
        aria-label="Open calendar"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          [class]="toggleIconClassFinal()"
          fill="currentColor"
        >
          <path
            d="M7 2a1 1 0 0 1 1 1v1h8V3a1 1 0 1 1 2 0v1h1.5A2.5 2.5 0 0 1 22 6.5v14
               A2.5 2.5 0 0 1 19.5 23h-15A2.5 2.5 0 0 1 2 20.5v-14
               A2.5 2.5 0 0 1 4.5 4H6V3a1 1 0 0 1 1-1Zm12.5 8h-15a.5.5 0 0 0-.5.5v10
               a.5.5 0 0 0 .5.5h15a.5.5 0 0 0 .5-.5v-10a.5.5 0 0 0-.5-.5Z"
          />
        </svg>
      </button>
    </div>
  </div>

  <!-- =====================
       Overlay
       ===================== -->
  <tng-overlay-ref
    #overlayRef="tngOverlayRef"
    [open]="isOpen()"
    (openChange)="onOverlayOpenChange($event)"
    (closed)="onOverlayClosed($event)"
  >
    <tng-connected-overlay
      [open]="overlayRef.isOpen()"
      [anchor]="inputEl"
      placement="bottom-start"
      width="content"
      [closeOnInsideClick]="false"
      (closed)="overlayRef.close($event)"
    >
      <tng-overlay-panel [slot]="overlayPanelSlot()">
        <!-- Popup frame -->
        <div [class]="panelFrameClassFinal()">
          <!-- =====================
               Body layout
               ===================== -->
          <div [class]="panelLayoutClassFinal()">

            <!-- ========= Months ========= -->
            <div [class]="monthRailClassFinal()">
              <div [class]="monthListClassFinal()">
                @for (m of months; track m.index) {
                  <button
                    type="button"
                    [class]="monthItemClassFinal()"
                    [class.bg-fg]="isMonthSelected(m.index)"
                    [class.text-bg]="isMonthSelected(m.index)"
                    [class.opacity-40]="isMonthDisabled(m.index)"
                    [disabled]="isMonthDisabled(m.index)"
                    (click)="selectMonth(m.index)"
                  >
                    {{ m.label }}
                  </button>
                }
              </div>
            </div>

            <!-- ========= Calendar ========= -->
            <div [class]="calendarClassFinal()">
              <div [class]="titleClassFinal()">
                Select Date
              </div>

              <!-- Weekdays -->
              <div [class]="weekdayRowClassFinal()">
                @for (d of weekdays; track d) {
                  <div [class]="weekdayCellClassFinal()">{{ d }}</div>
                }
              </div>

              <!-- Days -->
              <div [class]="dayGridClassFinal()">
                @for (cell of calendarCells(); track $index) {
                  <button
                    type="button"
                    [class]="dayCellClassFinal()"
                    [class.text-fg]="cell.isOutsideMonth"
                    [class.hover:bg-fg]="!isCellDisabled(cell) && !isCellSelected(cell)"
                    [class.hover:text-bg]="!isCellDisabled(cell) && !isCellSelected(cell)"
                    [class.bg-fg]="isCellSelected(cell)"
                    [class.text-bg]="isCellSelected(cell)"
                    [class.opacity-40]="isCellDisabled(cell)"
                    [class.ring-2]="isCellFocused(cell) && !isCellSelected(cell)"
                    [class.ring-border]="isCellFocused(cell) && !isCellSelected(cell)"
                    [disabled]="isCellDisabled(cell)"
                    (click)="selectDay(cell)"
                  >
                    {{ cell.label }}
                  </button>
                }
              </div>

              <!-- Preview -->
              <div [class]="previewTextClassFinal()">
                {{ previewLabel() }}
              </div>

              <!-- Actions -->
              <div [class]="actionBarClassFinal()">
                <button
                  type="button"
                  [class]="cancelClassFinal()"
                  (click)="cancel()"
                >
                  Cancel
                </button>

                <button
                  type="button"
                  [class]="confirmClassFinal()"
                  (click)="confirm()"
                >
                  Confirm
                </button>
              </div>
            </div>

            <!-- ========= Years (10 at a time) ========= -->
            <div [class]="yearRailClassFinal()">

              <!-- Up -->
              <button
                type="button"
                [class]="yearNavPrevClassFinal()"
                (click)="prevYearWindow()"
                [disabled]="!canPrevYearWindow()"
                aria-label="Previous 10 years"
              >
                ▲
              </button>

              <!-- Year list -->
              <div [class]="yearListClassFinal()">
                @for (y of years(); track (yearBase() + ':' + y)) {
                  <button
                    type="button"
                    [class]="yearItemClassFinal()"
                    [class.bg-fg]="isYearSelected(y)"
                    [class.text-bg]="isYearSelected(y)"
                    [class.opacity-40]="isYearDisabled(y)"
                    [disabled]="isYearDisabled(y)"
                    (click)="selectYear(y)"
                  >
                    {{ y }}
                  </button>
                }
              </div>
              
              <!-- Down -->
              <button
                type="button"
                [class]="yearNavNextClassFinal()"
                (click)="nextYearWindow()"
                [disabled]="!canNextYearWindow()"
                aria-label="Next 10 years"
              >
                ▼
              </button>
            </div>

          </div>
        </div>
      </tng-overlay-panel>
    </tng-connected-overlay>
  </tng-overlay-ref>
</div>
